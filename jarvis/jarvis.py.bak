import speech_recognition as sr
import wave
import datetime
import requests
import json

HOTWORD = "hey jarvis"
url = "http://localhost:1234/transcribe"

# --- Configuration ---
# Session management uses port 8000 (as specified in your GET/POST requests)
SESSION_URL = "http://127.0.0.1:5678/apps/agents/users/u_123/sessions/s_123"
# Agent execution uses port 5678 (as specified in your /run request)
RUN_URL = "http://127.0.0.1:5678/run"

# Common headers for JSON payloads
HEADERS = {"Content-Type": "application/json"}

SESSION_NOT_FOUND = {"detail": "Session not found"}


def wait_for_hotword(recognizer, mic):
    print("üéß Listening for hotword 'hey jarvis'...")
    with mic as source:
        recognizer.adjust_for_ambient_noise(source)

    while True:
        try:
            with mic as source:
                audio = recognizer.listen(source)
            text = recognizer.recognize_google(audio).lower()
            print(f"You said: {text}")

            if HOTWORD in text:
                print("‚úÖ Hotword detected!")
                return
        except sr.UnknownValueError:
            pass
        except KeyboardInterrupt:
            exit(0)


def record_until_silence(recognizer, mic):
    print("üéôÔ∏è Start speaking... (I will stop when silent for 3 seconds)")
    recognizer.pause_threshold = 3.0  # Silence length to stop

    with mic as source:
        audio = recognizer.listen(source)

    # Convert SR audio data ‚Üí raw WAV bytes
    wav_data = audio.get_wav_data()        # raw WAV-encoded bytes
    sample_width = audio.sample_width      # correct sample width
    sample_rate = audio.sample_rate        # correct sample rate

    #filename = datetime.datetime.now().strftime("jarvis_record_%Y%m%d_%H%M%S.wav")
    filename="jarvis_record.wav"

    with wave.open(filename, "wb") as wf:
        wf.setnchannels(1)
        wf.setsampwidth(sample_width)
        wf.setframerate(sample_rate)
        wf.writeframes(wav_data)

    print(f"‚úÖ Recording saved as: {filename}")
    return filename


def main():
    recognizer = sr.Recognizer()
    mic = sr.Microphone()

    while True:
        #wait_for_hotword(recognizer, mic)
        filename=record_until_silence(recognizer, mic)
        with open(filename, "rb") as f:
            files = {"file": ("audio.wav", f, "audio/wav")}
            response = requests.post(url, files=files).json()

        only_text = response["text"]
        print(only_text)
        get_response = requests.get(SESSION_URL, headers=HEADERS).json()
        
        if get_response.get("detail") == SESSION_NOT_FOUND.get("detail"):
            print(f"Session not found. Proceeding to create session...")
            print("\n--- 2. Creating new session (POST) ---")
            post_response = requests.post(SESSION_URL, headers=HEADERS)
            print(post_response)

        RUN_QUERY_PAYLOAD = {
            "app_name": "agents",
            "user_id": "u_123",
            "session_id": "s_123",
            "new_message": {
                "role": "user",
                "parts": [{"text": only_text}]
            }
        }

        response = requests.post(
            RUN_URL, 
            headers=HEADERS, 
            data=json.dumps(RUN_QUERY_PAYLOAD)
        )

        print(json.dumps(response.json(), indent=2))

        



if __name__ == "__main__":
    main()
